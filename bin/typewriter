#!/bin/zsh

_typewriter() {
  local msg="$1"
  for ((i=0; i<${#msg}; i++)); do
    printf "%s" "${msg:$i:1}"
    if read -s -t 0.04 -k 1 </dev/tty 2>/dev/null; then
      printf "%s" "${msg:$((i+1))}"
      break
    fi
  done
  printf "\n"
}

_typewriter_fortune() {
  local line
  while true; do
    while IFS= read -r line; do
      if [[ -n "$line" ]]; then
        _typewriter "$line"
      else
        printf "\n"
      fi
    done <<< "$(fortune)"
    printf "\n"
    sleep 1
  done
}

case "${1:-}" in
  --help|-h)
    echo "Usage: typewriter [message]"
    echo "       typewriter          # fortune mode (continuous)"
    echo "       typewriter <msg>    # type message char by char"
    ;;
  "")
    _typewriter_fortune
    ;;
  *)
    _typewriter "$1"
    ;;
esac
